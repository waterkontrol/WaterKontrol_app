<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WaterKontrol ‚Äì Detalle del dispositivo</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* Estilos espec√≠ficos para la vista de detalle del dispositivo */
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text-color);
      background-color: var(--background-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-header {
      background-color: var(--card-background);
      padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
      padding-right: 20px;
      padding-bottom: 16px;
      padding-left: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
      width: 100%;
      flex-shrink: 0;
    }

    .app-header h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-color);
      margin: 0;
      font-family: 'Inter', sans-serif;
      flex: 1;
      text-align: center;
    }

    .btn-back {
      background-color: var(--primary-color);
      color: var(--primary-foreground);
      border: none;
      font-size: 18px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: opacity 0.2s;
      min-width: 36px;
      height: 36px;
    }

    .btn-back:hover {
      opacity: 0.9;
    }

    .btn-power {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      display: inline-flex;
      align-items: center;
      transition: opacity 0.2s;
    }

    .btn-power:hover {
      opacity: 0.7;
    }

    .power-icon {
      width: 24px;
      height: 24px;
      fill: #666;
    }

    .app-content {
      padding: 20px;
      max-width: 100%;
      flex: 1;
      width: 100%;
      background-color: var(--background-color);
    }

    #loading {
      text-align: center;
      color: var(--muted-foreground);
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      padding: 24px 0;
    }

    .error-state {
      text-align: center;
      padding: 48px 24px;
      color: #8C1C00;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
    }

    .device-name-card {
      background-color: var(--card-background);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    .device-name {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-color);
      margin: 0 0 8px 0;
      font-family: 'Inter', sans-serif;
    }

    .device-registered {
      font-size: 13px;
      color: var(--muted-foreground);
      margin: 0;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .device-specs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .spec-card {
      flex: 1;
      background-color: var(--card-background);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .spec-label {
      font-size: 12px;
      color: var(--muted-foreground);
      margin: 0 0 6px 0;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
    }

    .spec-value {
      font-size: 14px;
      color: var(--text-color);
      margin: 0;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
    }

    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .status-card {
      background-color: var(--card-background);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
    }

    .status-card.full-width {
      grid-column: 1 / -1;
    }

    .status-icon {
      width: 48px;
      height: 48px;
      fill: var(--primary-color);
    }

    .status-icon.water {
      fill: #2196F3;
    }

    .status-icon.valve {
      fill: #4CAF50;
    }

    .status-icon.pump {
      fill: #9C27B0;
    }

    .status-label {
      font-size: 14px;
      color: var(--muted-foreground);
      margin: 0;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
    }

    .status-value {
      font-size: 16px;
      color: var(--text-color);
      margin: 0;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
    }

    .level-card {
      background-color: var(--card-background);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    .level-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .level-title {
      font-size: 16px;
      color: var(--muted-foreground);
      margin: 0;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
    }

    .level-value-large {
      font-size: 48px;
      color: var(--text-color);
      margin: 0;
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      line-height: 1;
    }

    .level-percentage {
      font-size: 24px;
      color: var(--muted-foreground);
      font-weight: 500;
    }

    .info-divider {
      height: 1px;
      background-color: var(--input-border);
      margin: 20px 0;
    }

    .device-info-section {
      background-color: var(--card-background);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    .device-info-section:last-child {
      margin-bottom: 0;
    }

    .device-info-section h3 {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted-foreground);
      font-family: 'Inter', sans-serif;
      margin: 0 0 16px 0;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--input-border);
    }

    .info-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .info-label {
      font-size: 14px;
      color: var(--muted-foreground);
      font-family: 'Inter', sans-serif;
    }

    .info-value {
      font-size: 14px;
      color: var(--text-color);
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="app-header">
    <a href="/app.html" class="btn-back" aria-label="Cerrar">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>
    <h1>Detalles del Dispositivo</h1>
    <button class="btn-power" aria-label="Power">
      <svg class="power-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2v10m0 0a5 5 0 0 1 0 10 5 5 0 0 1 0-10z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
        <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <main class="app-content">
    <p id="loading">Cargando informaci√≥n del dispositivo...</p>
    <div id="deviceDetail" style="display: none;"></div>
  </main>
  <script src="/variables.js"></script>
  <script>
    async function loadDevice() {
      const loading = document.getElementById('loading');
      const detail = document.getElementById('deviceDetail');

      try {
        if(!sessionStorage.getItem('token')) {
          setTimeout(() => window.location.href = '/login.html', 1000);
          throw new Error('No autorizado: token no encontrado. Por favor, inicia sesi√≥n.');
        }

        // Obtener la serie de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const serie = urlParams.get('serie');

        if (!serie) {
          loading.textContent = 'Error: No se especific√≥ el dispositivo.';
          loading.style.color = '#8C1C00';
          return;
        }

        console.log('üîç Iniciando carga de dispositivo...');
        console.log('üîç Serie solicitada:', serie);
        console.log('üîç URL de API:', `${RAILWAY_API_URL}/api/dispositivo/${encodeURIComponent(serie)}`);
        console.log('üîç Token disponible:', sessionStorage.getItem('token') ? 'S√≠' : 'No');

        const response = await fetch(`${RAILWAY_API_URL}/api/dispositivo/${encodeURIComponent(serie)}`, {
          headers: {Authorization: 'Bearer ' + sessionStorage.getItem('token')}
        });

        console.log('üîç Respuesta HTTP:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok
        });

        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Dispositivo no encontrado.');
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const device = await response.json();
        console.log('üì¶ Dispositivo recibido (raw):', device);
        console.log('üì¶ Campos del dispositivo:', {
          modelo: device.modelo,
          serie: device.serie,
          tipo: device.tipo,
          marca: device.marca,
          topic: device.topic,
          estatus: device.estatus,
          nombre: device.nombre,
          fecha_registro: device.fecha_registro
        });

        loading.style.display = 'none';
        detail.style.display = 'block';

        // Formatear fecha
        const fechaRegistro = device.fecha_registro 
          ? new Date(device.fecha_registro).toLocaleDateString('es-ES', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              hour12: true
            }).replace(',', '')
          : 'No disponible';

        detail.innerHTML = `
          <!-- Nombre del dispositivo -->
          <div class="device-name-card">
            <h1 class="device-name">${device.nombre || device.modelo}</h1>
            <p class="device-registered">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M3 10h18M8 2v4M16 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Registrado el: ${fechaRegistro}
            </p>
          </div>

          <!-- Especificaciones (Modelo y Serial) -->
          <div class="device-specs">
            <div class="spec-card">
              <p class="spec-label">Modelo:</p>
              <p class="spec-value">${device.modelo}</p>
            </div>
            <div class="spec-card">
              <p class="spec-label">Serial:</p>
              <p class="spec-value">${device.serie}</p>
            </div>
          </div>

          <!-- Estados (V√°lvula, Bomba) -->
          <div class="status-grid">
            <div class="status-card">
              <svg class="status-icon valve" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <circle cx="32" cy="32" r="28" fill="none" stroke="currentColor" stroke-width="4"/>
                <path d="M32 12v40M20 20h24M18 32h28M20 44h24" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              </svg>
              <p class="status-label">V√°lvula</p>
              <p class="status-value">Abierta</p>
            </div>
            <div class="status-card">
              <svg class="status-icon pump" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <rect x="12" y="20" width="40" height="28" rx="4" fill="none" stroke="currentColor" stroke-width="4"/>
                <circle cx="24" cy="34" r="6" fill="none" stroke="currentColor" stroke-width="3"/>
                <path d="M30 34h10M52 26v4M52 34v4" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              </svg>
              <p class="status-label">Bomba</p>
              <p class="status-value">Apagada</p>
            </div>
            <div class="status-card full-width">
              <svg class="status-icon water" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 32h40M12 24h40M12 40h40M12 48h40" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <rect x="8" y="20" width="48" height="32" rx="2" fill="none" stroke="currentColor" stroke-width="4"/>
              </svg>
              <p class="status-label">Ingreso</p>
              <p class="status-value">No</p>
            </div>
          </div>

          <!-- Nivel -->
          <div class="level-card">
            <div class="level-header">
              <p class="level-title">Nivel %</p>
            </div>
            <div style="display: flex; align-items: baseline; gap: 4px;">
              <p class="level-value-large">0</p>
              <span class="level-percentage">%</span>
            </div>
          </div>

          <!-- Informaci√≥n adicional -->
          <div class="device-info-section">
            <h3>Informaci√≥n T√©cnica</h3>
            <div class="info-row">
              <span class="info-label">Tipo</span>
              <span class="info-value">${device.tipo}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Marca</span>
              <span class="info-value">${device.marca}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Topic MQTT</span>
              <span class="info-value" style="font-size: 11px; word-break: break-all; max-width: 200px;">${device.topic}</span>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error:', error);
        loading.textContent = 'Error al cargar dispositivo: ' + error.message;
        loading.style.color = '#8C1C00';
      }
    }

    // Inicializar la carga
    loadDevice();
  </script>
</body>
</html>
